<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Ses Alıcısı</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background: #222; color: #fff; }
        button { padding: 15px 30px; font-size: 20px; cursor: pointer; background: #007bff; border: none; color: white; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Ses Yayını (Düşük Gecikme Modu)</h1>
    <p>Sesi duymak için butona basmalısın.</p>
    <button id="playBtn">Yayını Başlat</button>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let audioCtx;
        let nextTime = 0;
        
        // ÖNEMLİ: C# tarafındaki SampleRate ile AYNI olmalı (16000)
        const SAMPLE_RATE = 16000; 

        document.getElementById('playBtn').addEventListener('click', async () => {
            if (!audioCtx) {
                // Tarayıcının kendi hızı neyse onu kullanır (genelde 44.1k veya 48k)
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                document.getElementById('playBtn').innerText = "Bağlandı - Dinleniyor...";
                document.getElementById('playBtn').style.background = "green";
            } else if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
        });

        socket.on('play-audio', (arrayBuffer) => {
            if (!audioCtx) return;

            // 1. Gelen Veriyi İşle (Int16 -> Float32)
            const int16Array = new Int16Array(arrayBuffer);
            const float32Array = new Float32Array(int16Array.length);

            for (let i = 0; i < int16Array.length; i++) {
                float32Array[i] = int16Array[i] / 32768; // Normalize et (-1.0 ile 1.0 arası)
            }

            // 2. Ses Buffer'ı Oluştur (16000 Hz olduğunu burada belirtiyoruz)
            const audioBuffer = audioCtx.createBuffer(1, float32Array.length, SAMPLE_RATE);
            audioBuffer.getChannelData(0).set(float32Array);

            // 3. Oynatma Zamanlaması (Jitter Buffer Mantığı)
            const source = audioCtx.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioCtx.destination);

            // Eğer nextTime geçmişte kaldıysa (takılma olduysa),
            // zamanı "şu an + küçük bir gecikme" olarak sıfırla.
            if (nextTime < audioCtx.currentTime) {
                nextTime = audioCtx.currentTime + 0.10; // 100ms tampon payı bırak
            }

            source.start(nextTime);
            
            // Bir sonraki parçanın başlama zamanını ayarla
            nextTime += audioBuffer.duration;
        });
    </script>
</body>
</html>
